rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /** -------------------------------------------------------
     *  Helper: Check if the authenticated user is an Admin
     *  -------------------------------------------------------
     *  - Safely checks if user exists and has Admin role
     *  - Returns false if user doc doesn't exist or role is missing
     */
    function isAdmin() {
      return request.auth != null
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }

    /** -------------------------------------------------------
     *  Helper: Check if user is authenticated
     *  ------------------------------------------------------- */
    function isAuthenticated() {
      return request.auth != null;
    }

    /** -------------------------------------------------------
     *  Helper: Check if request is for the authed user
     *  ------------------------------------------------------- */
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    /** -------------------------------------------------------
     *  Helper: Sensitive fields on user docs
     *  -------------------------------------------------------
     *  These must NOT be writable by normal clients, otherwise users
     *  can self-upgrade plans, reset usage counters, or set role=Admin.
     *
     *  Server-side code (Firebase Admin SDK) bypasses rules.
     */
    function restrictedUserFields() {
      return [
        // Privilege / billing
        'role',
        'plan',
        'stripeCustomerId',
        'stripeSubscriptionId',
        'subscriptionStatus',
        'billingCycle',
        'cancelAtPeriodEnd',
        'subscriptionStartDate',
        'subscriptionEndDate',
        'lastPaymentDate',
        'trialUsed',
        'trialStartedAt',

        // Usage / quota (prevent client resets)
        'monthlyCaptionGenerationsUsed',
        'monthlyImageGenerationsUsed',
        'monthlyVideoGenerationsUsed',
        'monthlyRepliesUsed',
        'storageUsed',
        'storageLimit',

        // Invite-grant markers (server-controlled)
        'inviteGrantPlan',
        'inviteGrantExpiresAt',
        'inviteGrantExpiredAt'
      ];
    }

    function isSafeUserCreate() {
      // New users must start as normal users on Free plan.
      // Allow optional pending payment markers (used for signup flow),
      // but do NOT allow any Stripe IDs or elevated role/plan.
      return request.resource.data.role == 'User'
        && request.resource.data.plan == 'Free'
        && !(request.resource.data.keys().hasAny([
          'stripeCustomerId',
          'stripeSubscriptionId',
          'subscriptionStartDate',
          'subscriptionEndDate',
          'cancelAtPeriodEnd',
          'lastPaymentDate',
          'trialUsed',
          'trialStartedAt',
          'inviteGrantPlan',
          'inviteGrantExpiresAt',
          'inviteGrantExpiredAt'
        ]));
    }

    function isSafeUserUpdate() {
      // Prevent updating any restricted fields from the client.
      return !(request.resource.data.diff(resource.data).changedKeys().hasAny(restrictedUserFields()));
    }

    /** -------------------------------------------------------
     *  USERS COLLECTION
     *  -------------------------------------------------------
     *  - User can read/write ONLY their own top-level user doc
     *  - Admins can read/write ALL user docs (including plan updates)
     *  ------------------------------------------------------- */
    match /users/{userId} {

      // User can read themselves
      allow read: if isOwner(userId);

      // User can create their own doc with restricted defaults only
      allow create: if isOwner(userId) && isSafeUserCreate();

      // User can update their own doc EXCEPT restricted fields
      allow update: if isOwner(userId) && isSafeUserUpdate();

      // Admin override - Admins can read/write any user document
      // This allows Admin users to update plans, roles, and other user fields
      allow read, write: if isAdmin();

      /** ---------------------------------------------------
       * USER SUBCOLLECTIONS (messages, posts, CRM, calendar, voices, strategies, media_library, etc.)
       * ----------------------------------------------------
       * - Users can fully manage their own subcollections
       * - Admins get full access to all subcollections
       */
      match /{subCollection=**}/{docId} {
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
        allow read, write: if isAdmin();
      }
    }

    /** -------------------------------------------------------
     *  MODEL USAGE LOGS COLLECTION
     *  -------------------------------------------------------
     *  - Admins can read model usage logs for analytics
     *  - Regular users cannot access this collection
     *  - Only backend/server can write logs (via Admin SDK)
     *  ------------------------------------------------------- */
    match /model_usage_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Only backend/server can write logs via Admin SDK
    }

    /** -------------------------------------------------------
     *  ADMIN CONFIG COLLECTION
     *  -------------------------------------------------------
     *  - Admins can read/write admin configuration docs
     *  - Regular users cannot access this collection
     *  ------------------------------------------------------- */
    match /admin/{docId} {
      allow read, write: if isAdmin();
    }

    /** -------------------------------------------------------
     *  AD SCREENSHOTS COLLECTION
     *  -------------------------------------------------------
     *  - Admins can read/write ad screenshots for ad generation
     *  - Regular users cannot access this collection
     *  ------------------------------------------------------- */
    match /ad_screenshots/{docId} {
      allow read, write: if isAdmin();
    }

    /** -------------------------------------------------------
     *  AD GENERATOR HISTORY COLLECTION
     *  -------------------------------------------------------
     *  - Admins can read/write ad generator history
     *  - Regular users cannot access this collection
     *  ------------------------------------------------------- */
    match /ad_generator_history/{docId} {
      allow read, write: if isAdmin();
    }

    /** -------------------------------------------------------
     *  DEFAULT DENY RULE
     *  ------------------------------------------------------- 
     *  Deny all other collections to prevent unauthorized access
     */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
