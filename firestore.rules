rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /** -------------------------------------------------------
     *  Helper: Check if the authenticated user is an Admin
     *  -------------------------------------------------------
     *  - Safely checks if user exists and has Admin role
     *  - Returns false if user doc doesn't exist or role is missing
     */
    function isAdmin() {
      return request.auth != null
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }

    /** -------------------------------------------------------
     *  Helper: Check if user is authenticated
     *  ------------------------------------------------------- */
    function isAuthenticated() {
      return request.auth != null;
    }

    /** -------------------------------------------------------
     *  USERS COLLECTION
     *  -------------------------------------------------------
     *  - User can read/write ONLY their own top-level user doc
     *  - Admins can read/write ALL user docs (including plan updates)
     *  ------------------------------------------------------- */
    match /users/{userId} {

      // User can read/write themselves
      allow read, write: if isAuthenticated() && request.auth.uid == userId;

      // Admin override - Admins can read/write any user document
      // This allows Admin users to update plans, roles, and other user fields
      allow read, write: if isAdmin();

      /** ---------------------------------------------------
       * USER SUBCOLLECTIONS (messages, posts, CRM, calendar, voices, strategies, media_library, etc.)
       * ----------------------------------------------------
       * - Users can fully manage their own subcollections
       * - Admins get full access to all subcollections
       */
      match /{subCollection=**}/{docId} {
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
        allow read, write: if isAdmin();
      }
    }

    /** -------------------------------------------------------
     *  MODEL USAGE LOGS COLLECTION
     *  -------------------------------------------------------
     *  - Admins can read model usage logs for analytics
     *  - Regular users cannot access this collection
     *  - Only backend/server can write logs (via Admin SDK)
     *  ------------------------------------------------------- */
    match /model_usage_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Only backend/server can write logs via Admin SDK
    }

    /** -------------------------------------------------------
     *  ADMIN CONFIG COLLECTION
     *  -------------------------------------------------------
     *  - Admins can read/write admin configuration docs
     *  - Regular users cannot access this collection
     *  ------------------------------------------------------- */
    match /admin/{docId} {
      allow read, write: if isAdmin();
    }

    /** -------------------------------------------------------
     *  DEFAULT DENY RULE
     *  ------------------------------------------------------- 
     *  Deny all other collections to prevent unauthorized access
     */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
